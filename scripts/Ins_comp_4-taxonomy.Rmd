---
title: "Ins_comp_4-taxonomy"
author: "laura"
date: "2024-01-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# The project

Does rearing in a different insectary affect the mosquito microbiome?

# The setup

one cohort of Ae aegypti eggs were split into 3 and reared in standard conditions to see how their microbiomes varied between insectaries at diff life stages.


https://bioconductor.org/packages/release/bioc/vignettes/MicrobiotaProcess/inst/doc//MicrobiotaProcess.html

This script looks at what bacterial taxa are present in different groups and sample types (big picture) will follow up after with DESeq2 and heatmaps to identify ASVs associated with different insectaries

Actually, the second option I used, with the phyloseq object made for a better plot/easier plotting.





# Install packages

```{r}
# phyloseq itself
#if(!requireNamespace("BiocManager")){
#  install.packages("BiocManager")
#   }
#BiocManager::install("phyloseq")

# if (!requireNamespace("BiocManager", quietly=TRUE))
 #   install.packages("BiocManager")
## BiocManager::install("BiocUpgrade") ## you may need this
#BiocManager::install("MicrobiotaProcess")
 

#install.packages("gghalves") # required for `mp_plot_alpha()`
#install.packages("ggh4x") # required for `mp_plot_alpha()`


library(phyloseq)
library(ggplot2)
library(tidyverse)
library(dplyr) # for select command
library(MicrobiotaProcess) # not loading for now as concentrating on option2
library("ggalluvial") # needed for the abundance plot in microbiotaProcess

```

# import data

```{r}
ps = readRDS("physeq_obj_3974") # currently phyloseq obj

```


# Firstly, go through analysis using the microbiotaprocess package

```{r}
# convert phyloseq object to mpse to use with MicrobiotaProcess package
mpse <- ps %>% as.MPSE() 

mpse

```
## calculate abundance

Shouldn't need this as it's already a rarefied table, but I think I need this for subsequent steps to understand the data organisation

```{r}
mpse2 <- mpse %<>%
    mp_cal_abundance( # for each samples
      .abundance = Abundance
    ) %>%
    mp_cal_abundance( # for each groups 
      .abundance=Abundance,
      .group=Sample_Type2
    )
mpse2

```

### visualize the relative abundance of top 20 phyla for each sample.

```{r}

p1 <- mpse2 %>%
         mp_plot_abundance(
           .abundance=RareAbundance,
           .group=Sample_Type2, 
           taxa.class = Phylum, 
           topn = 20,
           relative = TRUE
         )
p1

```
This is too messy but shows the general idea

### phyla by sample type

mostly here I'm just playing around with the package to have an overview of the data

```{r}
# visualize the relative abundance of top 20 phyla for each .group (Sample type)
p2 <- mpse2 %>%
         mp_plot_abundance(
            .abundance=RareAbundance, 
            .group=Sample_Type2,
            taxa.class = Phylum,
            topn = 20,
            plot.group = TRUE
          )

p2

```

....and by building

```{r}
# visualize the relative abundance of top 20 phyla for each .group (building)
p3 <- mpse2 %>%
         mp_plot_abundance(
            .abundance=RareAbundance, 
            .group=Building,
            taxa.class = Phylum,
            topn = 20,
            plot.group = TRUE
          )

p3

```


### generate building/sampletype plots as genus level

break down into sample types then buidings or vice versa to better show differences between sampletypes and . Facetting with the default code doesn't work.

```{r}

mpse_adult <- subset(mpse2,  mpse2$Sample_Type2 == "AdultFemale")
 

p4 <- mpse_adult %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )


mpse_larva <- subset(mpse2,  mpse2$Sample_Type2 == "Larva")
 

p5 <- mpse_larva %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )


mpse_larvalwater <- subset(mpse2,  mpse2$Sample_Type2 == "LarvalWater") # this one not working?
 

p6 <- mpse_larvalwater %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )



mpse_water <- subset(mpse2,  mpse2$Sample_Type2 == "Water") # this one not working?
 

p7 <- mpse_water %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )


mpse_sugar <- subset(mpse2,  mpse2$Sample_Type2 == "Sugar")
 

p8 <- mpse_sugar %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )

mpse_food <- subset(mpse2,  mpse2$Sample_Type2 == "FishFood") # this one not working?
 

p9 <- mpse_food %>%
         mp_plot_abundance(
            .abundance=Abundance, 
            .group=Building,
            taxa.class = Genus,
            topn = 20,
            plot.group = TRUE
          )

p4 / p5 / p6 / p7 / p8 / p9

```



# second way, starting with the phyloseq obj

https://rpubs.com/lgschaerer/1006964 
the plot i am looking for is in the second half of the tutorial but I'll go through the whole thing to check how it all goes and for future ref

This needs tidyverse and phyloseq

```{r}
rm(list = ls()) # clear env

ps = readRDS("physeq_obj_3974") # currently phyloseq obj

head(sample_data(ps))

```


STEP #1: Convert the phyloseq object into a dataframe that can be more easily manipulated

```{r}
genusabundance <- ps %>%
  tax_glom(taxrank = "Genus") %>%                        # Set to smallest taxonomic level you are interested in
  transform_sample_counts(function(x) {x/sum(x)} ) %>%   # Transform to rel. abundance
  psmelt()                                               # Melt to long format
head(genusabundance)

```

STEP #2: Filter, group and modify data to prepare for plotting.

select() function: Choose which variables to include in the plot. Select ALL variables that will be used for x-axis and/or facet labels in addition to all taxonomic levels you are interested in.

filter() function: Filter out all taxa with zero percent abundance. Filter can also be used to remove treatments or conditions that are not to be included in the plot.

mutate() function: Convert the taxonomic level columns to character vectors (they are factors by default), can also be used to add additional columns or modify existing columns as desired.

```{r}
all <- genusabundance %>%
  select(Phylum, Class, Family, Genus, SampleID, Abundance, Sample_Type2, Building) %>%
  filter(Abundance != 0) %>%
  mutate(
    Phylum = as.character(Phylum),
    Class = as.character(Class),
    Family = as.character(Family),
    Genus = as.character(Genus))
head(all)

```
STEP #3: Prepare to plot Phylum
Here we will group the data even more to prepare to make a taxa plot at the Phylum level

group_by() function: Groups data by the specified variables. Include ONLY the variables that will be used in the ggplot() command to make the plot. Adding additional variables here can lead to aesthetic problems with the plot.

summarise() function: This function will collapse the data based on the groups specified in the group_by() function above. Here we will calculate the average abundance for each group (sum of the abundance of each phyla for each unique substrate/replicate combination divided by the total number of samples in each group).

More detailed explanation of this code block: select() select the variables desired for plotting, dropping excess variables will help code run faster. group_by() group by the variables that will be used for plotting, these will be updated for each plot. mutate() add a new column giving the number of samples in each group. In this case there is only one sample in each group, but the code provided here will calculate whatever the number of samples in the group is. ungroup() remove previous groupings. group_by() group by the variables that will be used for plotting PLUS the number of samples in each group (totalSum), and the taxonomic level you are going to plot, in this case, Genus. summarise() is used to do two things: (1) calculate the sum of abundance of all organisms in each group belonging to each genus. In this case, for each unique substrate and replicate combination, we calculate the sum() the abundance of each genus. (2) calculate relative abundance. unique() selects only the unique observations and removes any duplicate rows.

```{r}
phylum <- all %>%
  select(Sample_Type2, Building, Phylum, Abundance) %>%  #choose variables to work with
  group_by(Sample_Type2, Building,) %>%                   #group by variables used to plot NOT taxonomic level
  mutate(totalSum = sum(Abundance)) %>%                                 #calculate total abundance of each Phylum
  ungroup() %>%                                                         #remove grouping variables
  group_by(Sample_Type2, Building, Phylum) %>%           #group by same variables PLUS taxonomic level
  summarise(                                                            
    Abundance = sum(Abundance),                                         #sum abundance in each phylum for each  group
    totalSum,
    RelAb = Abundance/totalSum) %>%                                     #calculate relative abundance
  unique()

head(phylum)

```



```{r}
# Look at descriptive statistics to check that everything is as we would expect. Maximum relative abundance should be no more than one, and the minimum should be greater than zero. The mean should be between the maximum and the minimum.

max(phylum$RelAb)
mean(phylum$RelAb)
min(phylum$RelAb)
```
STEP #4: Prepare colors for the plot
Calculate how many colors will be needed. This is equal to the length of the unique values in the Phylum column of the “phylum” data frame, which in this case is 32. Here we will make a character vector containing a list of colors (phylum_colors) and then check the length to be sure there are enough colors… 
32 is too many colours to be actually useful but for now I'll keep it to go through the tutorial


```{r}
length(unique(phylum$Phylum))
phylum_colors <- c(
    "#56187D","#AC0123", "#006347","#97D0A7", "#EF9F26", "#E6CD69", "#7AA8D7",  "#00A087FF","#3C5488FF", "#9C58A1", "grey22", "darkcyan", "orchid1", "orange", "blue", "tomato2", "olivedrab", "grey47",
  "coral3", "darkgreen", "palegoldenrod", "dodgerblue", "firebrick", "yellow", "purple4",
  "lightblue", "grey77", "mediumpurple1", "tan4", "red", "darkblue", "yellowgreen")

length(phylum_colors)
```
STEP #5: Make a plot!
geom_col(): this creates the columns in the plot. The bars should add to exactly 1, if they do not add to 1, check grouping variables since this is the most likely place something went wrong. If the bars do add exactly to 1, percentages from the data frame can be multiplied by 100 to be interpreted as relative abundances. If you end up with many small blocks of the same color, check grouping variables in Step # 3, it’s likely you have multiple groups of the same genus represented by a single bar.

Note on using aes(): Anything inside the aes() function will create a legend (for example, “Fill = Phylum” is inside the aes() function since we want a legend to interpret the phylum colors). Anything outside outside aes() will NOT create a legend (for example, “Color = black” is outside the aes() function since we do not want a legend for the outline around the colored blocks).

facet_grid(): divides the figure into panels based on the variables provided.

scale_fill_manual(): specifies vector of colors to use instead of default colors.

theme_linedraw(): sets theme for graphic. Additional themes are available.

theme(): aesthetic tweaks to appearance, font size, legend position, etc.

guides(): adjusts legend appearance. Can alter the number of rows/columns in the legend.

```{r}
plotA <- ggplot(phylum)+
  geom_col(mapping = aes(x = Building, y = RelAb, fill = Phylum), color = "black", position = "stack", show.legend = TRUE)+
  facet_grid(cols = vars(Sample_Type2))+
  ylab("Proportion of Community") +
  xlab(NULL)+
  scale_fill_manual(values = phylum_colors) +
  theme_linedraw()+
  theme(axis.text.y = element_text(size = 20, color = "black"),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_text(size = 20, angle = 0, vjust = 1, hjust = 0.5, color = "black"),
        legend.text = element_text(size = 13),
        legend.position = "bottom",
        legend.spacing.x = unit(0.1, 'mm'),
        legend.spacing.y = unit(0.05, 'mm'),
        plot.margin=grid::unit(c(0.1,0.1,0.1,0.1), "mm"),
        strip.text = element_text(size = 18, face = "bold", angle = 0),
        legend.title = element_text(face="bold", size = 22))+
  guides(fill=guide_legend(ncol=3,byrow=TRUE))

plotA

```
Great looks good, but the level is too high and there's too many low abundant phyla that can't really be seen, so the second half of the tutorial

STEP #6: Plotting other taxonomic levels, grouping low abundance taxa.
Plotting other taxonomic levels is very similar, starting with the “all” dataframe we created earlier, modify the grouping variables to desired taxonomic level. This example will be grouped by genus.

```{r}
genus <- all %>%
  select(Sample_Type2, Building,  Genus, Abundance) %>%
  group_by(Sample_Type2, Building, ) %>%
  mutate(totalSum = sum(Abundance)) %>%
  ungroup() %>%
  group_by(Sample_Type2, Building, Genus) %>%
  summarise(
    Abundance = sum(Abundance),
    totalSum,
    RelAb = Abundance/totalSum) %>%
  unique()

head(genus)

```

Check the distribution of the data, max, mean and minimum should all be between 1 and >0. Here we also check the number of unique genera, there are 818! It would be impossible to visualize 818 colors in a single figure.

```{r}
max(genus$RelAb)
mean(genus$RelAb)
min(genus$RelAb)
length(unique(genus$Genus))

```
One solution for this is to group low abundance genera into a single category. Starting with the data frame “all” created earlier, we will group all of the genera present at less than 5% relative abundance into a single group.

Using mutate() paired with ifelse() and summarise() we will group any taxa with low (< 5% relative abundance) into a single category, reducing the number of colors needed.

More detailed explanation of this code block: select() select the variables desired for plotting, dropping excess variables will help code run faster. group_by() group by the variables that will be used for plotting, these will be updated for each plot. mutate() add a new column giving the number of samples in each group. In this case there is only one sample in each group, but the code provided here will calculate whatever the number of samples in the group is. ungroup() remove previous groupings. group_by() group by the variables that will be used for plotting PLUS the number of samples in each group (totalSum), and the taxonomic level you are going to plot, in this case, Genus. summarise() is used to do two things: (1) calculate the sum of abundance of all organisms in each group belonging to each genus. In this case, for each unique substrate and replicate combination, we calculate the sum() the abundance of each genus. (2) we use ifelse() to check if the summed abundance is less than 0.05 (5%), if it is, the Genus name is replaced with “< 5 %”. Now, as the last step, we use group_by() and summarise() to calculate the sum of abundance again (so the low abundance taxa are treated as a single category), and calculate relative abundance. unique() selects only the unique observations and removes any duplicate rows.



```{r}
genus <- all %>%
  select(Sample_Type2, Building, Genus, Abundance) %>%
  group_by(Sample_Type2, Building) %>%
  mutate(totalSum = sum(Abundance)) %>%
  ungroup() %>%
  group_by(Sample_Type2, Building, Genus, totalSum) %>%
  summarise(
    Abundance = sum(Abundance),
    Genus = ifelse(Abundance < 0.05, "< 5 %", Genus)) %>%               #change Genus label to group low abundance taxa together
  group_by(Sample_Type2, Building, Genus, totalSum) %>%  #now group and summarize again to group newly labeled low abundance taxa together
  summarise(
    Abundance = sum(Abundance),
    RelAb = Abundance/totalSum) %>%
  unique()

head(genus)

```

```{r}
length(unique(genus$Genus))

```
53 is too many - moved to grouping anything <10%, this resulted in 38 colours, moving to 15% - now 30, still a bit big but let's see how it looks

```{r}
genus15 <- all %>%
  select(Sample_Type2, Building, Genus, Abundance) %>%
  group_by(Sample_Type2, Building) %>%
  mutate(totalSum = sum(Abundance)) %>%
  ungroup() %>%
  group_by(Sample_Type2, Building, Genus, totalSum) %>%
  summarise(
    Abundance = sum(Abundance),
    Genus = ifelse(Abundance < 0.15, "< 15 %", Genus)) %>%               #change Genus label to group low abundance taxa together
  group_by(Sample_Type2, Building, Genus, totalSum) %>%  #now group and summarize again to group newly labeled low abundance taxa together
  summarise(
    Abundance = sum(Abundance),
    RelAb = Abundance/totalSum) %>%
  unique()

length(unique(genus15$Genus))

```
One way to get a long vector of colors is to use colorRampPalette to make a color palette based on a few supplied colors.

```{r}
colFunc <- colorRampPalette(c("purple4", "lightpink", "firebrick", "orange", "lemonchiffon", "olivedrab4", "darkcyan", "lightblue", "darkblue"))
color_list <- colFunc(length(unique(genus15$Genus)))
genus_colors <- c("black", color_list)
length(genus_colors)

```

```{r}
plotB <- abund_plot <- ggplot(genus15)+
  geom_col(mapping = aes(x = Building, y = RelAb, fill = Genus), color = "black", position = "stack", show.legend = TRUE)+
  facet_grid(cols = vars(Sample_Type2))+
  ylab("Proportion of Community") +
  xlab(NULL)+
  scale_fill_manual(values = genus_colors) +
  theme_linedraw()+
  theme(axis.text.y = element_text(size = 20, color = "black"),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_text(size = 20, angle = 0, vjust = 1, hjust = 0.5, color = "black"),
        legend.text = element_text(size = 13),
        legend.position = "bottom",
        legend.spacing.x = unit(0.1, 'mm'),
        legend.spacing.y = unit(0.05, 'mm'),
        plot.margin=grid::unit(c(0.1,0.1,0.1,0.1), "mm"),
        strip.text = element_text(size = 18, face = "bold", angle = 0),
        legend.title = element_text(face="bold", size = 22))+
  guides(fill=guide_legend(ncol=3,byrow=TRUE))

plotB

```


Looks good, but now to ammend slightly and look at some variations.
some of the fish food samples are really diverse so setting the min relative abindance to 45 removes a lot. This is a high threshold so can look in other ways too, but it shows the main stuff. It leaves the top 22 samples in the dataset so that might be the nicest way to say it. Actually, I might adjust the % until it leaves the top 20 genera then its a nicer number,- I've done that and classed the remainder as "other"

```{r}
genus_top20 <- all %>%
  select(Sample_Type2, Building, Genus, Abundance) %>%
  group_by(Sample_Type2, Building) %>%
  mutate(totalSum = sum(Abundance)) %>%
  ungroup() %>%
  group_by(Sample_Type2, Building, Genus, totalSum) %>%
  summarise(
    Abundance = sum(Abundance),
    Genus = ifelse(Abundance < 0.41, "_other", Genus)) %>%               #change Genus label to group low abundance taxa together
  group_by(Sample_Type2, Building, Genus, totalSum) %>%  #now group and summarize again to group newly labeled low abundance taxa together
  summarise(
    Abundance = sum(Abundance),
    RelAb = Abundance/totalSum) %>%
  unique()

length(unique(genus_top20$Genus))

```

```{r}
colFunc <- colorRampPalette(c("purple4", "lightpink", "firebrick", "orange", "lemonchiffon", "olivedrab4", "darkcyan", "lightblue", "darkblue"))
color_list_top20 <- colFunc(length(unique(genus_top20$Genus)))
genus_colors_top20 <- c("black", color_list_top20)
length(genus_colors_top20)
print(color_list_top20)

```

```{r}
colours <- c(
  "_other" = "black",
  "Acinetobacter" = "#638B27",
  "Asaia" = "#7AA8D7", 
  "Burkholderia-Caballeronia-Paraburkholderia" = "#AC0123", 
  "Edaphobacter" = "#E49DB8", 
  "Massilia" = "#97D0A7", 
  "Phreatobacter" = "#56187D", 
  "Sphingobacterium" = "#006347", 
  "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium" = "#00008B",
  "Bifidobacterium" = "#00A087FF",
  "Candidatus_Brocadia" = "#DFE2A9",
  "Elizabethkingia" = "#E6CD69",
  "Microbacterium" = "#EF9F26",
  "Pseudomonas" = "#DA6610",
  "Vibrio" = "#CA5054",
  "Arthrospira_PCC-7345" = "#9C58A1",
  "Bosea" = "#7FC3CE",
  "Delftia" = "#3C5488FF",
  "Flavobacterium" = "#FFE8A1",
  "Peredibacter" = "#485AB1" ,
  "Solitalea" = "#EA8F97"
)
 #  "#9C5BA1"    "#BA2F1E"  "#FA9E01", "#FFC44B"   "#A0B360"  "#378B53" "#0B8B7F" "#36A3A7", "#91B5D7" 


```

```{r}
plotD <- abund_plot <- ggplot(genus_top20)+
  geom_col(mapping = aes(x = Building, y = RelAb, fill = Genus), color = "black", position = "stack", show.legend = TRUE)+
  facet_grid(~factor(Sample_Type2, levels=c("AdultFemale", "Larva", "LarvalWater", "Water", "Sugar", "FishFood")), scales = "free", space = "free")+
  ylab("Proportion of Community") +
  xlab(NULL)+
  scale_fill_manual(values = colours) +
#  theme_linedraw()+
  theme(axis.text.y = element_text(size = 14, color = "black"),
        axis.title.y = element_text(size = 14, color = "black"),
        axis.text.x = element_text(size = 14, angle = 45, vjust = 1, hjust = 1, color = "black"),
        legend.text = element_text(size = 14),
        legend.position = "right",
        legend.spacing.x = unit(0.1, 'mm'),
        legend.spacing.y = unit(0.05, 'mm'),
        plot.margin=grid::unit(c(0.3,0.3,0.3,0.3), "mm"),
        strip.text = element_text(size = 16, face = "bold", angle = 0),
        legend.title = element_text(face="bold", size = 14))+
  guides(fill=guide_legend(ncol=1,byrow=TRUE))

plotD

```

```{r}
colFunc2 <- colorRampPalette(c("#56187D", "#AC0123","#006347",  "#EF9F26", "#E6CD69", "#7AA8D7", "#EA8F97", "#97D0A7"))
color_list_top20_B <- colFunc2(length(unique(genus_top20$Genus)))
genus_colors_top20_B <- c("black", color_list_top20_B)
length(genus_colors_top20_B)
print(color_list_top20_B)


```



```{r}
plotD <- abund_plot <- ggplot(genus_top20)+
  geom_col(mapping = aes(x = Building, y = RelAb, fill = Genus), color = "black", position = "stack", show.legend = TRUE)+
  facet_grid(~factor(Sample_Type2, levels=c("AdultFemale", "Larva", "LarvalWater", "Water", "Sugar", "FishFood")), scales = "free", space = "free")+
  ylab("Proportion of Community") +
  xlab(NULL)+
  scale_fill_manual(values = color_list_top20_B) +
#  theme_linedraw()+
  theme(axis.text.y = element_text(size = 14, color = "black"),
        axis.title.y = element_text(size = 14, color = "black"),
        axis.text.x = element_text(size = 14, angle = 45, vjust = 1, hjust = 1, color = "black"),
        legend.text = element_text(size = 14),
        legend.position = "right",
        legend.spacing.x = unit(0.1, 'mm'),
        legend.spacing.y = unit(0.05, 'mm'),
        plot.margin=grid::unit(c(0.3,0.3,0.3,0.3), "mm"),
        strip.text = element_text(size = 16, face = "bold", angle = 0),
        legend.title = element_text(face="bold", size = 14))+
  guides(fill=guide_legend(ncol=1,byrow=TRUE))

plotD

```
```{r}
colours2 <- c(
  "_other" = "black",
  "Acinetobacter" = "#638B27",
  "Asaia" = "#7AA8D7", 
  "Burkholderia-Caballeronia-Paraburkholderia" = "#AC0123", 
  "Edaphobacter" = "#E49DB8", 
  "Massilia" = "#97D0A7", 
  "Phreatobacter" = "#56187D", 
  "Sphingobacterium" = "#006347", 
  "Allorhizobium-Neorhizobium-Pararhizobium-Rhizobium" = "#00008B",
  "Bifidobacterium" = "#CA5054",
  "Candidatus_Brocadia" = "#DFE2A9",
  "Elizabethkingia" = "#E6CD69",
  "Microbacterium" = "#EA8F97",
  "Pseudomonas" = "#DA6610",
  "Vibrio" = "#00A087FF",
  "Arthrospira_PCC-7345" = "#9C58A1",
  "Bosea" = "#7FC3CE",
  "Delftia" = "#3C5488FF",
  "Flavobacterium" = "#FFE8A1",
  "Peredibacter" = "#485AB1" ,
  "Solitalea" = "#EF9F26"
)
 #  "#9C5BA1"    "#BA2F1E"  "#FA9E01", "#FFC44B"   "#A0B360"  "#378B53" "#0B8B7F" "#36A3A7", "#91B5D7" 


```

```{r}
plotF <- abund_plot <- ggplot(genus_top20)+
  geom_col(mapping = aes(x = Building, y = RelAb, fill = Genus), color = "black", position = "stack", show.legend = TRUE)+
  facet_grid(~factor(Sample_Type2, levels=c("AdultFemale", "Larva", "LarvalWater", "Water", "Sugar", "FishFood")), scales = "free", space = "free")+
  ylab("Proportion of Community") +
  xlab(NULL)+
  scale_fill_manual(values = colours2) +
#  theme_linedraw()+
  theme(axis.text.y = element_text(size = 14, color = "black"),
        axis.title.y = element_text(size = 14, color = "black"),
        axis.text.x = element_text(size = 14, angle = 45, vjust = 1, hjust = 1, color = "black"),
        legend.text = element_text(size = 14),
        legend.position = "right",
        legend.spacing.x = unit(0.1, 'mm'),
        legend.spacing.y = unit(0.05, 'mm'),
        plot.margin=grid::unit(c(0.3,0.3,0.3,0.3), "mm"),
        strip.text = element_text(size = 16, face = "bold", angle = 0),
        legend.title = element_text(face="bold", size = 14))+
  guides(fill=guide_legend(ncol=1,byrow=TRUE))

plotF

```







